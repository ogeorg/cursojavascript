<!DOCTYPE html>
<html>
<head>
  <title>Marvel: Nuevo comic</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="lib/bootstrap/css/bootstrap.css" rel="stylesheet" media="screen">
  <link href="css/marvel.css" rel="stylesheet">
  <script src="lib/jquery/jquery.js"></script>
  <script src="lib/bootstrap/js/bootstrap.js"></script>
  <script>
    var server = "http://localhost:8001/";
    $(document).ready(function(){
      $.get(server + "characters", function(characters){
        var $chars = $("#comicChar");
        characters.forEach(function(character){
          var id = character.id;
          var name = character.name;
          $chars.append($("<option value='"+id+"'>"+name+"</option>"));
        });
      });

      $('#submit').click(function(){
        var ret = true;

        var $comicTitle = $("#comicTitle");
        if ($comicTitle.val().trim() == "") {
          $comicTitle.parent().addClass("has-error");
          ret = false;
        }

        var $comicChar = $("#comicChar");
        if ($comicChar.val() == null) {
          $comicChar.parent().addClass("has-error");
          ret = false;
        }


        return ret;
      });

      function updateGroup(ok, $gp, error) {
        if (ok) {
          $gp.removeClass("has-error").addClass("has-success");
          $gp.find(".help-block").hide();
        } else {
          $gp.removeClass("has-success").addClass("has-error");
          $gp.find(".help-block").html(error).show();
        }
      }

      $("#comicId").on("change", function() {
        var $this = $(this);
        var $parent = $this.parent();
        var valor = $this.val();
        if (valor && valor > 1000) {

          var p1 = $.get(server + "comic/" + valor);
          var p2 = $.get(server + "comic/" + valor);

          //eventos, callbacks y promesas

          p1.then(p2).then(callback)

          $.when(p1, p2).then(callback);


          $.ajax(server + "comic/" + valor)
          .done(function() {
            // exito significa que ha encontrado un comic
            updateGroup(false, $parent, "El comic ya existe");
          })
          .fail(function() {
            // error significa que no existe este comic
            updateGroup(true, $parent);
            // alert(ajaxContext.responseText)
          });
        } else {
          updateGroup(false, $parent, "El identificador debe ser > 1000");
        }

      });
    });
  </script>
</head>
<body>

<header>
  [<a href="index.html">Buscar</a>][<a href="crear.html">Crear</a>]
</header>
<div class="content">
  <h1>Introduzca un nuevo comic</h1>
  <form method="get">
    <div class="form-group">
      <label class="control-label" for="comicId">Id del comic</label>
      <input class="form-control" type="number" id="comicId" placeholder="123">
      <div style="display: none" class="help-block"></div>
    </div>
    <div class="form-group">
      <label class="control-label" for="comicTitle">Título</label>
      <input class="form-control" type="text" id="comicTitle" placeholder="Título">
    </div>
    <div class="form-group">
      <label class="control-label" for="comicChar">Personaje</label>
      <select class="form-control" id="comicChar" multiple>
      </select>
    </div>
    <button id='submit' type="submit" class="btn btn-default">Submit</button>
  </form>

</div>

</body>
</html>